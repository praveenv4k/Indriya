// marionette-threejs - v0.0.4
//
// https://github.com/Stonelinks/marionette-threejs
//
// Simple wrappers around three.js components using Backbone.Marionette
//
// Copyright (c)2014 - Lucas Doyle <lucas.p.doyle@gmail.com>
//
// Distributed under MIT license
//

!function(a,b){if("function"==typeof define&&define.amd)define(["backbone","marionette","threejs","exports"],function(c,d,e,f){a.m3js=b(a,f,c,d,e)});else if("undefined"!=typeof exports){var c=require("backbone"),d=require("marionette"),e=require("threejs");b(a,exports,c,d,e)}else a.m3js=b(a,{},a.Backbone,a.Marionette,a.THREE)}(this,function(a,b,c,d,e){"use strict";e.OrbitControls=function(a,b){function c(){return 2*Math.PI/60/60*f.autoRotateSpeed}function d(){return Math.pow(.95,f.zoomSpeed)}this.object=a,this.domElement=void 0!==b?b:document,this.enabled=!0,this.target=new e.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var f=this,g=1e-6,h=new e.Vector2,i=new e.Vector2,j=new e.Vector2,k=new e.Vector2,l=new e.Vector2,m=new e.Vector2,n=new e.Vector3,o=new e.Vector3,p=new e.Vector2,q=new e.Vector2,r=new e.Vector2,s=0,t=0,u=1,v=new e.Vector3,w=new e.Vector3,x=new e.Quaternion,y={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},z=y.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var A=(new e.Quaternion).setFromUnitVectors(a.up,new e.Vector3(0,1,0)),B=A.clone().inverse(),C={type:"change"},D={type:"start"},E={type:"end"};this.rotateLeft=function(a){void 0===a&&(a=c()),t-=a},this.rotateUp=function(a){void 0===a&&(a=c()),s-=a},this.panLeft=function(a){var b=this.object.matrix.elements;n.set(b[0],b[1],b[2]),n.multiplyScalar(-a),v.add(n)},this.panUp=function(a){var b=this.object.matrix.elements;n.set(b[4],b[5],b[6]),n.multiplyScalar(a),v.add(n)},this.pan=function(a,b){var c=f.domElement===document?f.domElement.body:f.domElement;if(void 0!==f.object.fov){var d=f.object.position,e=d.clone().sub(f.target),g=e.length();g*=Math.tan(f.object.fov/2*Math.PI/180),f.panLeft(2*a*g/c.clientHeight),f.panUp(2*b*g/c.clientHeight)}else void 0!==f.object.top?(f.panLeft(a*(f.object.right-f.object.left)/c.clientWidth),f.panUp(b*(f.object.top-f.object.bottom)/c.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(a){void 0===a&&(a=d()),u/=a},this.dollyOut=function(a){void 0===a&&(a=d()),u*=a},this.update=function(){var a=this.object.position;o.copy(a).sub(this.target),o.applyQuaternion(A);var b=Math.atan2(o.x,o.z),d=Math.atan2(Math.sqrt(o.x*o.x+o.z*o.z),o.y);this.autoRotate&&this.rotateLeft(c()),b+=t,d+=s,d=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,d)),d=Math.max(g,Math.min(Math.PI-g,d));var e=o.length()*u;e=Math.max(this.minDistance,Math.min(this.maxDistance,e)),this.target.add(v),o.x=e*Math.sin(d)*Math.sin(b),o.y=e*Math.cos(d),o.z=e*Math.sin(d)*Math.cos(b),o.applyQuaternion(B),a.copy(this.target).add(o),this.object.lookAt(this.target),t=0,s=0,u=1,v.set(0,0,0),(w.distanceToSquared(this.object.position)>g||8*(1-x.dot(this.object.quaternion))>g)&&(this.dispatchEvent(C),w.copy(this.object.position),x.copy(this.object.quaternion))},this.reset=function(){z=y.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},this.onMouseDown=function(a){if(f.enabled!==!1){if(a.preventDefault(),0===a.button){if(f.noRotate===!0)return;z=y.ROTATE,h.set(a.clientX,a.clientY)}else if(1===a.button){if(f.noZoom===!0)return;z=y.DOLLY,p.set(a.clientX,a.clientY)}else if(2===a.button){if(f.noPan===!0)return;z=y.PAN,k.set(a.clientX,a.clientY)}document.addEventListener("mousemove",f.onMouseMove,!1),document.addEventListener("mouseup",f.onMouseUp,!1),f.dispatchEvent(D)}},this.onMouseMove=function(a){if(f.enabled!==!1){a.preventDefault();var b=f.domElement===document?f.domElement.body:f.domElement;if(z===y.ROTATE){if(f.noRotate===!0)return;i.set(a.clientX,a.clientY),j.subVectors(i,h),f.rotateLeft(2*Math.PI*j.x/b.clientWidth*f.rotateSpeed),f.rotateUp(2*Math.PI*j.y/b.clientHeight*f.rotateSpeed),h.copy(i)}else if(z===y.DOLLY){if(f.noZoom===!0)return;q.set(a.clientX,a.clientY),r.subVectors(q,p),r.y>0?f.dollyIn():f.dollyOut(),p.copy(q)}else if(z===y.PAN){if(f.noPan===!0)return;l.set(a.clientX,a.clientY),m.subVectors(l,k),f.pan(m.x,m.y),k.copy(l)}f.update()}},this.onMouseUp=function(){f.enabled!==!1&&(document.removeEventListener("mousemove",f.onMouseMove,!1),document.removeEventListener("mouseup",f.onMouseUp,!1),f.dispatchEvent(E),z=y.NONE)},this.onMouseWheel=function(a){if(f.enabled!==!1&&f.noZoom!==!0){a.preventDefault(),a.stopPropagation();var b=0;void 0!==a.wheelDelta?b=a.wheelDelta:void 0!==a.detail&&(b=-a.detail),b>0?f.dollyOut():f.dollyIn(),f.update(),f.dispatchEvent(D),f.dispatchEvent(E)}},this.onKeyDown=function(a){if(f.enabled!==!1&&f.noKeys!==!0&&f.noPan!==!0)switch(a.keyCode){case f.keys.UP:f.pan(0,f.keyPanSpeed),f.update();break;case f.keys.BOTTOM:f.pan(0,-f.keyPanSpeed),f.update();break;case f.keys.LEFT:f.pan(f.keyPanSpeed,0),f.update();break;case f.keys.RIGHT:f.pan(-f.keyPanSpeed,0),f.update()}},this.touchstart=function(a){if(f.enabled!==!1){switch(a.touches.length){case 1:if(f.noRotate===!0)return;z=y.TOUCH_ROTATE,h.set(a.touches[0].pageX,a.touches[0].pageY);break;case 2:if(f.noZoom===!0)return;z=y.TOUCH_DOLLY;var b=a.touches[0].pageX-a.touches[1].pageX,c=a.touches[0].pageY-a.touches[1].pageY,d=Math.sqrt(b*b+c*c);p.set(0,d);break;case 3:if(f.noPan===!0)return;z=y.TOUCH_PAN,k.set(a.touches[0].pageX,a.touches[0].pageY);break;default:z=y.NONE}f.dispatchEvent(D)}},this.touchmove=function(a){if(f.enabled!==!1){a.preventDefault(),a.stopPropagation();var b=f.domElement===document?f.domElement.body:f.domElement;switch(a.touches.length){case 1:if(f.noRotate===!0)return;if(z!==y.TOUCH_ROTATE)return;i.set(a.touches[0].pageX,a.touches[0].pageY),j.subVectors(i,h),f.rotateLeft(2*Math.PI*j.x/b.clientWidth*f.rotateSpeed),f.rotateUp(2*Math.PI*j.y/b.clientHeight*f.rotateSpeed),h.copy(i),f.update();break;case 2:if(f.noZoom===!0)return;if(z!==y.TOUCH_DOLLY)return;var c=a.touches[0].pageX-a.touches[1].pageX,d=a.touches[0].pageY-a.touches[1].pageY,e=Math.sqrt(c*c+d*d);q.set(0,e),r.subVectors(q,p),r.y>0?f.dollyOut():f.dollyIn(),p.copy(q),f.update();break;case 3:if(f.noPan===!0)return;if(z!==y.TOUCH_PAN)return;l.set(a.touches[0].pageX,a.touches[0].pageY),m.subVectors(l,k),f.pan(m.x,m.y),k.copy(l),f.update();break;default:z=y.NONE}}},this.touchend=function(){f.enabled!==!1&&(f.dispatchEvent(E),z=y.NONE)},this.onContextMenu=function(a){a.preventDefault()},this.update()},e.OrbitControls.prototype=Object.create(e.EventDispatcher.prototype),function(){var a=function(a){e.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.side=e.FrontSide,this.transparent=!0,this.setValues(a),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(a){a?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};a.prototype=Object.create(e.MeshBasicMaterial.prototype);var b=function(a){e.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.linewidth=1,this.setValues(a),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(a){a?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};b.prototype=Object.create(e.LineBasicMaterial.prototype),e.TransformGizmo=function(){var a=this,b=!1,c=!1;this.init=function(){e.Object3D.call(this),this.handles=new e.Object3D,this.pickers=new e.Object3D,this.planes=new e.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var a=new e.PlaneGeometry(50,50,2,2),b=new e.MeshBasicMaterial({wireframe:!0});b.side=e.DoubleSide;var c={XY:new e.Mesh(a,b),YZ:new e.Mesh(a,b),XZ:new e.Mesh(a,b),XYZE:new e.Mesh(a,b)};this.activePlane=c.XYZE,c.YZ.rotation.set(0,Math.PI/2,0),c.XZ.rotation.set(-Math.PI/2,0,0);for(var d in c)c[d].name=d,this.planes.add(c[d]),this.planes[d]=c[d],c[d].visible=!1;var f=function(a,b){for(var c in a)for(d=a[c].length;d--;){var e=a[c][d][0],f=a[c][d][1],g=a[c][d][2];e.name=c,f&&e.position.set(f[0],f[1],f[2]),g&&e.rotation.set(g[0],g[1],g[2]),b.add(e)}};f(this.handleGizmos,this.handles),f(this.pickerGizmos,this.pickers),this.traverse(function(a){if(a instanceof e.Mesh){a.updateMatrix();var b=new e.Geometry;b.merge(a.geometry,a.matrix),a.geometry=b,a.position.set(0,0,0),a.rotation.set(0,0,0),a.scale.set(1,1,1)}})},this.hide=function(){this.traverse(function(a){a.visible=!1})},this.show=function(){this.traverse(function(c){c.visible=!0,c.parent==a.pickers&&(c.visible=b),c.parent==a.planes&&(c.visible=!1)}),this.activePlane.visible=c},this.highlight=function(a){this.traverse(function(b){b.material&&b.material.highlight&&b.material.highlight(b.name==a?!0:!1)})}},e.TransformGizmo.prototype=Object.create(e.Object3D.prototype),e.TransformGizmo.prototype.update=function(a,b){var c=new e.Vector3(0,0,0),d=new e.Vector3(0,1,0),f=new e.Matrix4;this.traverse(function(e){-1!=e.name.search("E")?e.quaternion.setFromRotationMatrix(f.lookAt(b,c,d)):(-1!=e.name.search("X")||-1!=e.name.search("Y")||-1!=e.name.search("Z"))&&e.quaternion.setFromEuler(a)})},e.TransformGizmoTranslate=function(){e.TransformGizmo.call(this);var c=new e.Geometry,d=new e.Mesh(new e.CylinderGeometry(0,.05,.2,12,1,!1));d.position.y=.5,d.updateMatrix(),c.merge(d.geometry,d.matrix);var f=new e.Geometry;f.vertices.push(new e.Vector3(0,0,0),new e.Vector3(1,0,0));var g=new e.Geometry;g.vertices.push(new e.Vector3(0,0,0),new e.Vector3(0,1,0));var h=new e.Geometry;h.vertices.push(new e.Vector3(0,0,0),new e.Vector3(0,0,1)),this.handleGizmos={X:[[new e.Mesh(c,new a({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new e.Line(f,new b({color:16711680}))]],Y:[[new e.Mesh(c,new a({color:65280})),[0,.5,0]],[new e.Line(g,new b({color:65280}))]],Z:[[new e.Mesh(c,new a({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new e.Line(h,new b({color:255}))]],XYZ:[[new e.Mesh(new e.OctahedronGeometry(.1,0),new a({color:16777215,opacity:.25})),[0,0,0],[0,0,0]]],XY:[[new e.Mesh(new e.PlaneGeometry(.29,.29),new a({color:16776960,opacity:.25})),[.15,.15,0]]],YZ:[[new e.Mesh(new e.PlaneGeometry(.29,.29),new a({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new e.Mesh(new e.PlaneGeometry(.29,.29),new a({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]},this.pickerGizmos={X:[[new e.Mesh(new e.CylinderGeometry(.2,0,1,4,1,!1),new a({color:16711680,opacity:.25})),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new e.Mesh(new e.CylinderGeometry(.2,0,1,4,1,!1),new a({color:65280,opacity:.25})),[0,.6,0]]],Z:[[new e.Mesh(new e.CylinderGeometry(.2,0,1,4,1,!1),new a({color:255,opacity:.25})),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new e.Mesh(new e.OctahedronGeometry(.2,0),new a({color:16777215,opacity:.25}))]],XY:[[new e.Mesh(new e.PlaneGeometry(.4,.4),new a({color:16776960,opacity:.25})),[.2,.2,0]]],YZ:[[new e.Mesh(new e.PlaneGeometry(.4,.4),new a({color:65535,opacity:.25})),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new e.Mesh(new e.PlaneGeometry(.4,.4),new a({color:16711935,opacity:.25})),[.2,0,.2],[-Math.PI/2,0,0]]]},this.setActivePlane=function(a,b){var c=new e.Matrix4;b.applyMatrix4(c.getInverse(c.extractRotation(this.planes.XY.matrixWorld))),"X"==a&&(this.activePlane=this.planes.XY,Math.abs(b.y)>Math.abs(b.z)&&(this.activePlane=this.planes.XZ)),"Y"==a&&(this.activePlane=this.planes.XY,Math.abs(b.x)>Math.abs(b.z)&&(this.activePlane=this.planes.YZ)),"Z"==a&&(this.activePlane=this.planes.XZ,Math.abs(b.x)>Math.abs(b.y)&&(this.activePlane=this.planes.YZ)),"XYZ"==a&&(this.activePlane=this.planes.XYZE),"XY"==a&&(this.activePlane=this.planes.XY),"YZ"==a&&(this.activePlane=this.planes.YZ),"XZ"==a&&(this.activePlane=this.planes.XZ),this.hide(),this.show()},this.init()},e.TransformGizmoTranslate.prototype=Object.create(e.TransformGizmo.prototype),e.TransformGizmoRotate=function(){e.TransformGizmo.call(this);var c=function(a,b,c){var d=new e.Geometry;c=c?c:1;for(var f=0;64*c>=f;++f)"x"==b&&d.vertices.push(new e.Vector3(0,Math.cos(f/32*Math.PI),Math.sin(f/32*Math.PI)).multiplyScalar(a)),"y"==b&&d.vertices.push(new e.Vector3(Math.cos(f/32*Math.PI),0,Math.sin(f/32*Math.PI)).multiplyScalar(a)),"z"==b&&d.vertices.push(new e.Vector3(Math.sin(f/32*Math.PI),Math.cos(f/32*Math.PI),0).multiplyScalar(a));return d};this.handleGizmos={X:[[new e.Line(new c(1,"x",.5),new b({color:16711680}))]],Y:[[new e.Line(new c(1,"y",.5),new b({color:65280}))]],Z:[[new e.Line(new c(1,"z",.5),new b({color:255}))]],E:[[new e.Line(new c(1.25,"z",1),new b({color:13421568}))]],XYZE:[[new e.Line(new c(1,"z",1),new b({color:7895160}))]]},this.pickerGizmos={X:[[new e.Mesh(new e.TorusGeometry(1,.12,4,12,Math.PI),new a({color:16711680,opacity:.25})),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new e.Mesh(new e.TorusGeometry(1,.12,4,12,Math.PI),new a({color:65280,opacity:.25})),[0,0,0],[Math.PI/2,0,0]]],Z:[[new e.Mesh(new e.TorusGeometry(1,.12,4,12,Math.PI),new a({color:255,opacity:.25})),[0,0,0],[0,0,-Math.PI/2]]],E:[[new e.Mesh(new e.TorusGeometry(1.25,.12,2,24),new a({color:16776960,opacity:.25}))]],XYZE:[[new e.Mesh(new e.Geometry)]]},this.setActivePlane=function(a){"E"==a&&(this.activePlane=this.planes.XYZE),"X"==a&&(this.activePlane=this.planes.YZ),"Y"==a&&(this.activePlane=this.planes.XZ),"Z"==a&&(this.activePlane=this.planes.XY),this.hide(),this.show()},this.update=function(a,b){e.TransformGizmo.prototype.update.apply(this,arguments);var c=({handles:this.handles,pickers:this.pickers},new e.Matrix4),d=new e.Euler(0,0,1),f=new e.Quaternion,g=new e.Vector3(1,0,0),h=new e.Vector3(0,1,0),i=new e.Vector3(0,0,1),j=new e.Quaternion,k=new e.Quaternion,l=new e.Quaternion,m=b.clone();d.copy(this.planes.XY.rotation),f.setFromEuler(d),c.makeRotationFromQuaternion(f).getInverse(c),m.applyMatrix4(c),this.traverse(function(a){f.setFromEuler(d),"X"==a.name&&(j.setFromAxisAngle(g,Math.atan2(-m.y,m.z)),f.multiplyQuaternions(f,j),a.quaternion.copy(f)),"Y"==a.name&&(k.setFromAxisAngle(h,Math.atan2(m.x,m.z)),f.multiplyQuaternions(f,k),a.quaternion.copy(f)),"Z"==a.name&&(l.setFromAxisAngle(i,Math.atan2(m.y,m.x)),f.multiplyQuaternions(f,l),a.quaternion.copy(f))})},this.init()},e.TransformGizmoRotate.prototype=Object.create(e.TransformGizmo.prototype),e.TransformGizmoScale=function(){e.TransformGizmo.call(this);var c=new e.Geometry,d=new e.Mesh(new e.BoxGeometry(.125,.125,.125));d.position.y=.5,d.updateMatrix(),c.merge(d.geometry,d.matrix);var f=new e.Geometry;f.vertices.push(new e.Vector3(0,0,0),new e.Vector3(1,0,0));var g=new e.Geometry;g.vertices.push(new e.Vector3(0,0,0),new e.Vector3(0,1,0));var h=new e.Geometry;h.vertices.push(new e.Vector3(0,0,0),new e.Vector3(0,0,1)),this.handleGizmos={X:[[new e.Mesh(c,new a({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new e.Line(f,new b({color:16711680}))]],Y:[[new e.Mesh(c,new a({color:65280})),[0,.5,0]],[new e.Line(g,new b({color:65280}))]],Z:[[new e.Mesh(c,new a({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new e.Line(h,new b({color:255}))]],XYZ:[[new e.Mesh(new e.BoxGeometry(.125,.125,.125),new a({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new e.Mesh(new e.CylinderGeometry(.2,0,1,4,1,!1),new a({color:16711680,opacity:.25})),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new e.Mesh(new e.CylinderGeometry(.2,0,1,4,1,!1),new a({color:65280,opacity:.25})),[0,.6,0]]],Z:[[new e.Mesh(new e.CylinderGeometry(.2,0,1,4,1,!1),new a({color:255,opacity:.25})),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new e.Mesh(new e.BoxGeometry(.4,.4,.4),new a({color:16777215,opacity:.25}))]]},this.setActivePlane=function(a,b){var c=new e.Matrix4;b.applyMatrix4(c.getInverse(c.extractRotation(this.planes.XY.matrixWorld))),"X"==a&&(this.activePlane=this.planes.XY,Math.abs(b.y)>Math.abs(b.z)&&(this.activePlane=this.planes.XZ)),"Y"==a&&(this.activePlane=this.planes.XY,Math.abs(b.x)>Math.abs(b.z)&&(this.activePlane=this.planes.YZ)),"Z"==a&&(this.activePlane=this.planes.XZ,Math.abs(b.x)>Math.abs(b.y)&&(this.activePlane=this.planes.YZ)),"XYZ"==a&&(this.activePlane=this.planes.XYZE),this.hide(),this.show()},this.init()},e.TransformGizmoScale.prototype=Object.create(e.TransformGizmo.prototype),e.TransformControls=function(a,b){function c(c,d){var e=b.getBoundingClientRect(),f=(c.clientX-e.left)/e.width,g=(c.clientY-e.top)/e.height;k.set(2*f-1,2*-g+1,.5),j.unprojectVector(k,a),i.set(L,k.sub(L).normalize());var h=i.intersectObjects(d,!0);return h[0]?h[0]:!1}e.Object3D.call(this),b=void 0!==b?b:document,this.gizmo={},this.gizmo.translate=new e.TransformGizmoTranslate,this.gizmo.rotate=new e.TransformGizmoRotate,this.gizmo.scale=new e.TransformGizmoScale,this.add(this.gizmo.translate),this.add(this.gizmo.rotate),this.add(this.gizmo.scale),this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.object=void 0,this.snap=null,this.space="world",this.size=1,this.axis=null;var d=this,f=!1,g="translate",h={type:"change"},i=new e.Raycaster,j=new e.Projector,k=new e.Vector3,l=new e.Vector3,m=new e.Vector3,n=new e.Vector3,o=new e.Vector3,p=1,q=new e.Matrix4,r=new e.Vector3,s=new e.Matrix4,t=new e.Vector3,u=new e.Quaternion,v=new e.Vector3(1,0,0),w=new e.Vector3(0,1,0),x=new e.Vector3(0,0,1),y=new e.Quaternion,z=new e.Quaternion,A=new e.Quaternion,B=new e.Quaternion,C=new e.Quaternion,D=new e.Vector3,E=new e.Vector3,F=new e.Matrix4,G=new e.Matrix4,H=new e.Vector3,I=new e.Vector3,J=new e.Euler,K=new e.Matrix4,L=new e.Vector3,M=new e.Euler;this.attach=function(a){d.object=a,this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.gizmo[g].show(),d.update()},this.detach=function(){d.object=void 0,this.axis=void 0,this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide()},this.disable=function(){d.object=void 0,this.axis=void 0},this.setMode=function(a){g=a?a:g,"scale"==g&&(d.space="local"),this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.gizmo[g].show(),this.update(),d.dispatchEvent(h)},this.setSnap=function(a){d.snap=a},this.setSize=function(a){d.size=a,this.update(),d.dispatchEvent(h)},this.setSpace=function(a){d.space=a,this.update(),d.dispatchEvent(h)},this.update=function(){void 0!==d.object&&(d.object.updateMatrixWorld(),I.setFromMatrixPosition(d.object.matrixWorld),J.setFromRotationMatrix(s.extractRotation(d.object.matrixWorld)),a.updateMatrixWorld(),L.setFromMatrixPosition(a.matrixWorld),M.setFromRotationMatrix(s.extractRotation(a.matrixWorld)),p=I.distanceTo(L)/6*d.size,this.position.copy(I),this.scale.set(p,p,p),r.copy(L).sub(I).normalize(),"local"==d.space?this.gizmo[g].update(J,r):"world"==d.space&&this.gizmo[g].update(new e.Euler,r),this.gizmo[g].highlight(d.axis))},this.onPointerHover=function(a){if(void 0!==d.object&&f!==!0){a.preventDefault();var b=a.changedTouches?a.changedTouches[0]:a,e=c(b,d.gizmo[g].pickers.children);e?(d.axis=e.object.name,d.update(),d.dispatchEvent(h)):null!==d.axis&&(d.axis=null,d.update(),d.dispatchEvent(h))}},this.onPointerDown=function(a){if(void 0!==d.object&&f!==!0){a.preventDefault(),a.stopPropagation();var b=a.changedTouches?a.changedTouches[0]:a;if(0===b.button||void 0===b.button){var e=c(b,d.gizmo[g].pickers.children);if(e){d.axis=e.object.name,d.update(),r.copy(L).sub(I).normalize(),d.gizmo[g].setActivePlane(d.axis,r);var h=c(b,[d.gizmo[g].activePlane]);D.copy(d.object.position),E.copy(d.object.scale),F.extractRotation(d.object.matrix),K.extractRotation(d.object.matrixWorld),G.extractRotation(d.object.parent.matrixWorld),H.setFromMatrixScale(s.getInverse(d.object.parent.matrixWorld)),m.copy(h.point)}}f=!0}},this.onPointerMove=function(a){if(void 0!==d.object&&null!==d.axis&&f!==!1){a.preventDefault(),a.stopPropagation();var b=a.changedTouches?a.changedTouches[0]:a,e=c(b,[d.gizmo[g].activePlane]);l.copy(e.point),"translate"==g?(l.sub(m),l.multiply(H),"local"==d.space&&(l.applyMatrix4(s.getInverse(K)),-1==d.axis.search("X")&&(l.x=0),-1==d.axis.search("Y")&&(l.y=0),-1==d.axis.search("Z")&&(l.z=0),l.applyMatrix4(F),d.object.position.copy(D),d.object.position.add(l)),("world"==d.space||-1!=d.axis.search("XYZ"))&&(-1==d.axis.search("X")&&(l.x=0),-1==d.axis.search("Y")&&(l.y=0),-1==d.axis.search("Z")&&(l.z=0),l.applyMatrix4(s.getInverse(G)),d.object.position.copy(D),d.object.position.add(l)),null!==d.snap&&(-1!=d.axis.search("X")&&(d.object.position.x=Math.round(d.object.position.x/d.snap)*d.snap),-1!=d.axis.search("Y")&&(d.object.position.y=Math.round(d.object.position.y/d.snap)*d.snap),-1!=d.axis.search("Z")&&(d.object.position.z=Math.round(d.object.position.z/d.snap)*d.snap))):"scale"==g?(l.sub(m),l.multiply(H),"local"==d.space&&("XYZ"==d.axis?(p=1+l.y/50,d.object.scale.x=E.x*p,d.object.scale.y=E.y*p,d.object.scale.z=E.z*p):(l.applyMatrix4(s.getInverse(K)),"X"==d.axis&&(d.object.scale.x=E.x*(1+l.x/50)),"Y"==d.axis&&(d.object.scale.y=E.y*(1+l.y/50)),"Z"==d.axis&&(d.object.scale.z=E.z*(1+l.z/50))))):"rotate"==g&&(l.sub(I),l.multiply(H),t.copy(m).sub(I),t.multiply(H),"E"==d.axis?(l.applyMatrix4(s.getInverse(q)),t.applyMatrix4(s.getInverse(q)),n.set(Math.atan2(l.z,l.y),Math.atan2(l.x,l.z),Math.atan2(l.y,l.x)),o.set(Math.atan2(t.z,t.y),Math.atan2(t.x,t.z),Math.atan2(t.y,t.x)),u.setFromRotationMatrix(s.getInverse(G)),C.setFromAxisAngle(r,n.z-o.z),y.setFromRotationMatrix(K),u.multiplyQuaternions(u,C),u.multiplyQuaternions(u,y),d.object.quaternion.copy(u)):"XYZE"==d.axis?(C.setFromEuler(l.clone().cross(t).normalize()),u.setFromRotationMatrix(s.getInverse(G)),z.setFromAxisAngle(C,-l.clone().angleTo(t)),y.setFromRotationMatrix(K),u.multiplyQuaternions(u,z),u.multiplyQuaternions(u,y),d.object.quaternion.copy(u)):"local"==d.space?(l.applyMatrix4(s.getInverse(K)),t.applyMatrix4(s.getInverse(K)),n.set(Math.atan2(l.z,l.y),Math.atan2(l.x,l.z),Math.atan2(l.y,l.x)),o.set(Math.atan2(t.z,t.y),Math.atan2(t.x,t.z),Math.atan2(t.y,t.x)),y.setFromRotationMatrix(F),z.setFromAxisAngle(v,n.x-o.x),A.setFromAxisAngle(w,n.y-o.y),B.setFromAxisAngle(x,n.z-o.z),"X"==d.axis&&y.multiplyQuaternions(y,z),"Y"==d.axis&&y.multiplyQuaternions(y,A),"Z"==d.axis&&y.multiplyQuaternions(y,B),d.object.quaternion.copy(y)):"world"==d.space&&(n.set(Math.atan2(l.z,l.y),Math.atan2(l.x,l.z),Math.atan2(l.y,l.x)),o.set(Math.atan2(t.z,t.y),Math.atan2(t.x,t.z),Math.atan2(t.y,t.x)),u.setFromRotationMatrix(s.getInverse(G)),z.setFromAxisAngle(v,n.x-o.x),A.setFromAxisAngle(w,n.y-o.y),B.setFromAxisAngle(x,n.z-o.z),y.setFromRotationMatrix(K),"X"==d.axis&&u.multiplyQuaternions(u,z),"Y"==d.axis&&u.multiplyQuaternions(u,A),"Z"==d.axis&&u.multiplyQuaternions(u,B),u.multiplyQuaternions(u,y),d.object.quaternion.copy(u))),d.update(),d.dispatchEvent(h)}},this.onPointerUp=function(a){f=!1,d.onPointerHover(a)},this.isDragging=function(){return!(void 0===d.object||null===d.axis||f===!1)},this.eventIntersectsControl=function(a,b){var e=b.changedTouches?b.changedTouches[0]:b,h={onPointerHover:function(){if(void 0===d.object||f===!0)return!1;var a=c(e,d.gizmo[g].pickers.children);return a},onPointerDown:function(){if(void 0===d.object||f===!0)return!1;if(0===e.button||void 0===e.button){var a=c(e,d.gizmo[g].pickers.children);if(a){d.axis=a.object.name,d.update(),r.copy(L).sub(I).normalize(),d.gizmo[g].setActivePlane(d.axis,r);var b=c(e,[d.gizmo[g].activePlane]);return b}return!1}return!1},onPointerMove:function(){if(void 0===d.object||null===d.axis||f===!1)return!1;var a=c(e,[d.gizmo[g].activePlane]);return a}};return h[a]&&h[a](b)}},e.TransformControls.prototype=Object.create(e.Object3D.prototype)}();{var f=function(a,b){var c=function(){return a.apply(this,b)};return c.prototype=a.prototype,new c},g=function(a){return a&&a.charAt(0).toUpperCase()+a.slice(1)},h=(b.Drawable=c.Model.extend({defaults:{texture:"/img/crate.gif",geometryType:"BoxGeometry",geometryParams:[200,200,200],matrix:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},_mesh:void 0,_texture:void 0,_material:void 0,_geometry:void 0,initDrawable:function(){var a=this,b=function(){void 0!==a.collection&&a.collection.trigger("drawable:loaded",a),a.trigger("drawable:loaded",a),a.on("change:matrix",function(){a.updateMesh()}),a.updateMesh()};e.hasOwnProperty(this.get("geometryType"))?(this._texture=e.ImageUtils.loadTexture(this.get("texture"),new e.UVMapping,b),this._geometry=f(e[this.get("geometryType")],this.get("geometryParams")),this._material=new e.MeshLambertMaterial({map:this._texture}),this._mesh=new e.Mesh(this._geometry,this._material)):console.warn("Drawable: no compatible geometry type")},updateMesh:function(){this._mesh.matrix.set.apply(this._mesh.matrix,this.get("matrix")),this._mesh.matrix.decompose(this._mesh.position,this._mesh.quaternion,this._mesh.scale)},getMesh:function(){return this._mesh},initialize:function(){this.initDrawable()}}),b.OrbitControl=c.Model.extend({_control:void 0,initializeControl:function(){this._control=new e.OrbitControls(this.renderer.camera),this._control.damping=.1},getControl:function(){return this._control},disable:function(){this._control.enabled=!1},enable:function(){this._control.enabled=!0},isEnabled:function(){return this._control.enabled},dispatchDOMEvent:function(a){var b={contextmenu:"onContextMenu",mousedown:"onMouseDown",mousewheel:"onMouseWheel",DOMMouseScroll:"onMouseWheel",touchstart:"touchstart",touchend:"touchend",touchmove:"touchmove",keydown:"onKeyDown"};b[a.type]&&_.isFunction(this._control[b[a.type]])&&this._control[b[a.type]].call(this._control,a)},renderer:void 0,initialize:function(a){this.renderer=a.renderer,this.initializeControl()}})),i=b.TransformControl=c.Model.extend({defaults:{attachedDrawable:void 0,mode:"translate",space:"local"},_control:void 0,initializeControl:function(){var a=this;this._control=new e.TransformControls(this.renderer.camera,this.renderer.renderer.domElement),this._control.addEventListener("change",function(){var b=a.get("attachedDrawable"),c=b.getMesh().matrix.elements,d=Array.prototype.slice.call(c),e=d,f=[e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]];_.isEqual(b.get("matrix"),f)||b.set("matrix",f)}),a.renderer.scene.add(a._control)},getControl:function(){return this._control},getAttachedDrawable:function(){return this.get("attachedDrawable")},attachDrawable:function(a){this.get("attachedDrawable")!==a&&(this.set("attachedDrawable",a),this._control.attach(a.getMesh()))},detachDrawable:function(a){a=a||this.get("attachedDrawable"),this.set("attachedDrawable",void 0),a?this._control.disable(a.getMesh()):console.log("TransformControl: can't detach nonexistant drawable")},hasAttachedDrawable:function(){return this.get("attachedDrawable")},controlEventMap:{mousedown:"onPointerDown",touchstart:"onPointerDown",mousemove:["onPointerHover","onPointerMove"],touchmove:["onPointerHover","onPointerMove"],mouseup:"onPointerUp",mouseout:"onPointerUp",touchend:"onPointerUp",touchcancel:"onPointerUp",touchleave:"onPointerUp"},dispatchDOMEvent:function(a){var b=this,c=this.controlEventMap[a.type],d=_.isArray(c)?c:[c];d.forEach(function(c){b._control[c]&&b._control[c].call(b._control,a)})},intersectsControl:function(a){var b,c=this,d=this.controlEventMap[a.type],e=_.isArray(d)?d:[d];return e.forEach(function(d,e){var f=c._control.eventIntersectsControl(d,a);b=0==e?f:b||f}),b},isDragging:function(){return this._control.isDragging()},renderer:void 0,initialize:function(a){this.renderer=a.renderer,this.initializeControl(),this.on("change:mode",function(){this._control.setMode(this.get("mode"))}),this.on("change:space",function(){this._control.setSpace(this.get("space"))})}});b.ThreeJSRenderer=d.ItemView.extend({template:_.template("<div></div>"),collectionEvents:{remove:function(a){this.removeDrawable(a)},"drawable:loaded":function(a){this.addDrawable(a)}},_transformControlDragging:!1,onPointerDown:function(a){this.dispatchDOMEventToControls(a)},onPointerHover:function(a){this.dispatchDOMEventToControls(a)},onPointerMove:function(a){this.dispatchDOMEventToControls(a)},onPointerUp:function(a){if(this.dispatchDOMEventToControls(a),!this._transformControlDragging){var b=[];this.collection.forEach(function(a){var c=a.getMesh();if(c){var d=[];c.traverse(function(a){a&&d.push(a)}),d.forEach(function(c){b.push({drawable:a,mesh:c})})}}),this._raycast({event:a,callback:function(a){var c;a[0]&&(c=_.findWhere(b,{mesh:a[0].object}).drawable),c&&this.triggerMethod("drawable:pointerUp",c)}})}},onDrawablePointerUp:function(a){this.transformControl.attachDrawable(a)},onMouseWheel:function(a){this.dispatchDOMEventToControls(a)},onKeyDown:function(a){this.dispatchDOMEventToControls(a)},onContextMenu:function(a){this.dispatchDOMEventToControls(a)},getWidth:function(){return window.innerWidth-this.$el.find("div").offset().left-1},getHeight:function(){return window.innerHeight-this.$el.find("div").offset().top-5.25},camera:void 0,scene:void 0,renderer:void 0,setupRenderer:function(){this.renderer=new e.WebGLRenderer({precision:"highp",antialias:!0}),this.renderer.sortObjects=!1,this.renderer.setSize(this.getWidth(),this.getHeight()),this.renderer.setClearColor(11184810);var a=this,b=function(){a.$el.find("div").append(a.renderer.domElement)};b(),this.on("render",b)},setupCamera:function(){this.camera=new e.PerspectiveCamera(70,this.getWidth()/this.getHeight(),.01,1e4),this.camera.position.set(1e3,500,1e3),this.camera.lookAt(new e.Vector3(0,200,0))},setupScene:function(){this.scene=new e.Scene;var a=new e.GridHelper(1e3,100);a.setColors(4473924,8947848),this.scene.add(a);var b=new e.HemisphereLight(16777215,6576451);b.position.set(0,50,0),this.scene.add(b)},addDrawable:function(a){console.log("ThreeJSRenderer: add drawable");var b=a.getMesh();b&&this.scene.add(b)},removeDrawable:function(a){console.log("ThreeJSRenderer: remove drawable");var b=a.getMesh();b&&this.scene.remove(b)},onWindowResize:function(){this.camera.aspect=this.getWidth()/this.getHeight(),this.camera.updateProjectionMatrix(),this.renderer.setSize(this.getWidth(),this.getHeight())},startWebGLRendering:function(){var a=this,b=function(){a.transformControl.getControl().update(),a.renderer.render(a.scene,a.camera)},c=function(){requestAnimationFrame(c),b()};c()},pointerVector:new e.Vector3,rayCaster:new e.Raycaster,projector:new e.Projector,_raycast:function(a){var b=a.event,c=a.callback;if(c){var d=[];a.meshes?d=a.meshes:this.collection.forEach(function(a){a.getMesh()&&d.push(a.getMesh())});var e=this.renderer.domElement.getBoundingClientRect(),f=(b.clientX-e.left)/e.width,g=(b.clientY-e.top)/e.height;this.pointerVector.set(2*f-1,2*-g+1,.5),this.projector.unprojectVector(this.pointerVector,this.camera),this.rayCaster.set(this.camera.position,this.pointerVector.sub(this.camera.position).normalize());var h=this.rayCaster.intersectObjects(d,!0);c.call(this,h)}},transformControl:void 0,orbitControl:void 0,setupTransformControl:function(){this.transformControl||(this.transformControl=new i({renderer:this}),this.trigger("transformcontrols:create",this.transformControl))},disableTransformControl:function(){this.transformControl&&this.transformControl.hasAttachedDrawable()&&this.transformControl.detachDrawable()},setupOrbitControl:function(){this.orbitControl?this.orbitControl.enable():this.orbitControl=new h({renderer:this})},disableOrbitControl:function(){this.orbitControl&&this.orbitControl.isEnabled()&&this.orbitControl.disable()},setupPointerEvents:function(){var a=this.renderer.domElement,b={mousedown:"onPointerDown",touchstart:"onPointerDown",mousemove:["onPointerHover","onPointerMove"],touchmove:["onPointerHover","onPointerMove"],mouseup:"onPointerUp",mouseout:"onPointerUp",touchend:"onPointerUp",touchcancel:"onPointerUp",touchleave:"onPointerUp",mousewheel:"onMouseWheel",DOMMouseScroll:"onMouseWheel",keydown:"onKeyDown",contextmenu:"onContextMenu"},c=this;_.forEach(b,function(b,d){var e=_.isArray(b)?b:[b];e.forEach(function(b){a.addEventListener(d,c[b].bind(c),!1)})})},dispatchDOMEventToControls:function(a){this.transformControl.intersectsControl(a)||this.orbitControl.dispatchDOMEvent(a),this.transformControl?(this._transformControlDragging=this.transformControl.isDragging(),this.transformControl.dispatchDOMEvent(a)):this._transformControlDragging=!1
},initialize:function(){this.once("show",function(){this.setupRenderer(),this.setupCamera(),this.setupScene(),this.setupPointerEvents(),this.setupTransformControl(),this.setupOrbitControl();var a=this;window.addEventListener("resize",function(){a.onWindowResize()},!1),a.startWebGLRendering(),a.render()})}}),b.TransformControlMode=d.ItemView.extend({templateHelpers:function(){return{transformControlSpace:this.transformControl&&g(this.transformControl.get("space"))}},events:{"click #translate-mode":function(){this.transformControl.set("mode","translate")},"click #rotate-mode":function(){this.transformControl.set("mode","rotate")},"click #scale-mode":function(){this.transformControl.set("mode","scale")},"click #toggle-space":function(){var a="local"==this.transformControl.get("space")?"world":"local";this.transformControl.set("space",a),this.render()}},transformControl:void 0,initialize:function(a){this.transformControl=a.transformControl}})}return b});