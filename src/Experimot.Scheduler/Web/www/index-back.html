<!DOCTYPE html>
<html lang="en">
<head>
    <title>ExperimotWeb</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            font-family: Monospace;
            background-color: #000000;
            margin: 0;
            overflow: hidden;
        }

        #info {
            color: #fff;
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            display: block;
        }

        .toggle {
            float: right;
            padding: .6em;
            position: relative;
            z-index: 1;
        }

        a {
            color: skyblue;
        }

        /*#blocklyArea {
            height: 99%;
        }*/
    </style>

    <link type="text/css" rel="stylesheet" href="libs/jquery-ui/jquery-ui.min.css" />
    <link type="text/css" rel="stylesheet" href="libs/jquery-jsonview/jquery.jsonview.css" />
    <link type="text/css" rel="stylesheet" href="libs/slidebars/slidebars.min.css" />


    <script src="libs/jquery/jquery-2.1.3.min.js"></script>
    <script src="libs/jquery-ui/jquery-ui.min.js"></script>
    <script src="libs/jquery-jsonview/jquery.jsonview.js"></script>
    <script src="libs/slidebars/slidebars.min.js"></script>

    <script src="libs/google-blockly/blockly_compressed.js"></script>
    <script src="libs/google-blockly/blocks_compressed.js"></script>
    <script src="libs/google-blockly/msg/js/en.js"></script>
</head>
<body>
    <div id="sb-site">
        <!--<div id="tabs">-->
            <div id="tabs" style="width:100%; height:100%">
                <ul>
                    <li><a href="#tabs-1">Visualize</a></li>
                    <li><a href="#tabs-2">Design</a></li>
                    <li><a href="#tabs-3">Monitor</a></li>
                    <span class="toggle">
                        <button id="toggle-btn">TOGGLE</button>
                    </span>
                </ul>
                <div id="tabs-1">
                    <div id="viewport"></div>
                </div>
                <div id="tabs-2">
                    <div id="diagram"></div>
                </div>
                <div id="tabs-3">
                    <!--<table>
                <tr>
                    <td id="blocklyArea"></td>
                </tr>
            </table>
            <div id="blocklyDiv" style="position: absolute"></div>-->
                    <xml id="toolbox" style="display: none">
                        <block type="controls_if"></block>
                        <block type="logic_compare"></block>
                        <block type="controls_repeat_ext"></block>
                        <block type="math_number"></block>
                        <block type="math_arithmetic"></block>
                        <block type="text"></block>
                        <block type="text_print"></block>
                    </xml>
                </div>

                <!--<div class="sb-slidebar sb-left">
            <div id="tree1"></div>
        </div>-->
                <!--<span class="toggle">
                <button id="toggle-btn">TOGGLE</button>
        </span>-->
            </div>
    </div>
<div class="sb-slidebar sb-left">
    <div id="tree1"></div>
</div>


<!--<div id="info">
    <a href="http://threejs.org" target="_blank">three.js</a> -
    robot from <a href="https://github.com/rdiankov/collada_robots" target="_blank">collada robots</a>
</div>-->
<script src="libs/threejs/three.min.js"></script>
<script src="js/libs/tween.min.js"></script>
<script src="js/controls/OrbitControls.js"></script>
<script src="js/loaders/ColladaLoader.js"></script>
<script src="js/Detector.js"></script>
<script src="js/libs/stats.min.js"></script>

<script>

    if (!Detector.webgl) Detector.addGetWebGLMessage();

    var container, stats;

    var camera, scene, renderer, objects, controls;
    var particleLight;
    var dae;
    var jointvals;
    var jointvalIndex = 0;
    var delay = 5;
    var currDelay = 0;

    var kinematics;
    var kinematicsTween;
    var tweenParameters = {};
    var testAnimate = false;

    //$("#tabs").tabs();

    var handleSelect = function (e, tab) {
        if (tab.newTab.index() === 1) {
            console.log('tab selected');
            $.getJSON(
                '/context',
                function (data) {
                    $('#tree1').JSONView(data);
                }
            );
        }
    }

    var appSlidebar = new $.slidebars();

    $("#toggle-btn")
        .button()
        .click(function () {
            appSlidebar.slidebars.toggle('left');
        })
        .text("TOGGLE");

    $("#tabs").tabs({ beforeActivate: handleSelect }).css({
        'min-height': '400px',
        'overflow': 'auto'
    });

    

    var loader = new THREE.ColladaLoader();
    loader.options.convertUpAxis = true;

    if (testAnimate) {
        $.getJSON(
            '/jointvals',
            function(data) {
                console.log(data);
                jointvals = data;
            }
        );
    }

    loader.load("models/collada/nao.dae", function(collada) {

        dae = collada.scene;

        dae.traverse(function(child) {

            if (child instanceof THREE.Mesh) {

                child.geometry.computeFaceNormals();
                child.material.shading = THREE.FlatShading;

            }

        });

        dae.scale.x = dae.scale.y = dae.scale.z = 10.0;
        dae.updateMatrix();

        kinematics = collada.kinematics;

        //console.log(kinematics.joints.length);
        //for (var i = 0; i < kinematics.joints.length; i++) {

        //   console.log("Joint value "+ i.toString() + " : " + kinematics.getJointValue(i));

        //}
        init();
        animate();

    });

    function init() {
        //var handleSelect = function(e, tab) {
        //    if (tab.newTab.index() === 1) {
        //        console.log('tab selected');
        //        $.getJSON(
        //            '/context',
        //            function(data) {
        //                $('#tree1').JSONView(data);
        //            }
        //        );
        //    }
        //}

        //var appSlidebar = new $.slidebars();

        //$("#toggle-btn")
        //    .button()
        //    .click(function() {
        //        appSlidebar.slidebars.toggle('left');
        //    })
        //    .text("TOGGLE");

        //$("#tabs").tabs({ beforeActivate: handleSelect });

        container = document.getElementById('viewport');

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000000);
        //camera = new THREE.PerspectiveCamera(45, container.offsetWidth / container.offsetHeight, 1, 1000000);
        //camera.position.set(2, 2, 3);
        camera.position.set(10, 8, -10);

        controls = new THREE.OrbitControls(camera);

        scene = new THREE.Scene();

        // Grid

        var size = 14, step = 1;

        var geometry = new THREE.Geometry();
        var material = new THREE.LineBasicMaterial({ color: 0x303030 });

        for (var i = -size; i <= size; i += step) {

            geometry.vertices.push(new THREE.Vector3(-size, -0.04, i));
            geometry.vertices.push(new THREE.Vector3(size, -0.04, i));

            geometry.vertices.push(new THREE.Vector3(i, -0.04, -size));
            geometry.vertices.push(new THREE.Vector3(i, -0.04, size));

        }

        var line = new THREE.Line(geometry, material, THREE.LinePieces);
        scene.add(line);

        // Add the COLLADA

        scene.add(dae);

        particleLight = new THREE.Mesh(new THREE.SphereGeometry(4, 8, 8), new THREE.MeshBasicMaterial({ color: 0xffffff }));
        scene.add(particleLight);

        // Lights

        var directionalLight = new THREE.HemisphereLight(0xffeeee, 0x111122);
        directionalLight.position.x = Math.random() - 0.5;
        directionalLight.position.y = Math.random() - 0.5;
        directionalLight.position.z = Math.random() - 0.5;
        directionalLight.position.normalize();
        scene.add(directionalLight);

        var pointLight = new THREE.PointLight(0xffffff, 0.5);
        particleLight.add(pointLight);

        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        //renderer.setSize(container.offsetWidth, container.offsetHeight);
        container.appendChild(renderer.domElement);

        //stats = new Stats();
        //setupTween();
        //stats.domElement.style.position = 'absolute';
        //stats.domElement.style.top = '0px';
        //container.appendChild(stats.domElement);

        //

        window.addEventListener('resize', onWindowResize, false);
    }


    function setupTween() {

        var duration = getRandomInt(1000, 5000);

        var target = {}

        for (var i = 0; i < kinematics.joints.length; i++) {

            var joint = kinematics.joints[i];

            var old = tweenParameters[i];

            var position = old ? old : joint.zeroPosition;

            tweenParameters[i] = position;

            target[i] = getRandomInt(joint.limits.min, joint.limits.max);

        }

        kinematicsTween = new TWEEN.Tween(tweenParameters).to(target, duration).easing(TWEEN.Easing.Quadratic.Out);

        kinematicsTween.onUpdate(function() {

            for (var i = 0; i < kinematics.joints.length; i++) {

                kinematics.setJointValue(i, this[i]);

            }

        });

        kinematicsTween.start();

        setTimeout(setupTween, duration);

    }

    function onWindowResize() {

        //container = document.getElementById('viewport');
        //camera.aspect = container.offsetWidth / container.offsetHeight;
        //camera.updateProjectionMatrix();
        //renderer.setSize(container.offsetWidth, container.offsetHeight);

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);

    }

    function degrees(radians) {
        return radians * 180 / Math.PI;
    };

//

    function animate() {

        requestAnimationFrame(animate);

        if (testAnimate) {
            if (currDelay < delay) {
                currDelay++;
            } else {
                currDelay = 0;
                console.log(jointvals.length);
                if (jointvalIndex < jointvals.length) {
                    values = jointvals[jointvalIndex];
                    for (var i = 0; i < values.length; i++) {

                        kinematics.setJointValue(i, degrees(values[i]));

                    }
                    jointvalIndex++;
                }
            }
        }

        render();
        //stats.update();
        //TWEEN.update();

    }

    function render() {

        var timer = Date.now() * 0.0001;

        //camera.position.x = Math.cos(timer) * 17;
        //camera.position.y = 10;
        //camera.position.z = Math.sin(timer) * 17;

        //camera.lookAt(scene.position);

        particleLight.position.x = Math.sin(timer * 4) * 3009;
        particleLight.position.y = Math.cos(timer * 5) * 4000;
        particleLight.position.z = Math.cos(timer * 4) * 3009;

        renderer.render(scene, camera);

    }

    // Returns a random integer between min (inclusive) and max (inclusive)
    // Using Math.round() will give you a non-uniform distribution!

    function getRandomInt(min, max) {

        return Math.floor(Math.random() * (max - min + 1)) + min;

    }

</script>

<script>
    //var blocklyArea = document.getElementById('blocklyArea');
    //var blocklyDiv = document.getElementById('blocklyDiv');
    //var workspace = Blockly.inject(blocklyDiv,
    //{ toolbox: document.getElementById('toolbox') });
    //var onresize2 = function(e) {
    //    // Compute the absolute coordinates and dimensions of blocklyArea.
    //    var element = blocklyArea;
    //    var x = 0;
    //    var y = 0;
    //    do {
    //        x += element.offsetLeft;
    //        y += element.offsetTop;
    //        element = element.offsetParent;
    //    } while (element);
    //    // Position blocklyDiv over blocklyArea.
    //    blocklyDiv.style.left = x + 'px';
    //    blocklyDiv.style.top = y + 'px';
    //    blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
    //    blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
    //};
    //window.addEventListener('resize', onresize2, false);
    //onresize2();
    var workspace = Blockly.inject('tabs-3',
        { toolbox: document.getElementById('toolbox') });
</script>
<!--<div class="sb-slidebar sb-left sb-width-custom" data-sb-width="25%">
    <div id="tree1"></div>
</div>-->
</body>
</html>
